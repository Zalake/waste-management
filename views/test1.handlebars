<div id="map_wrapper">
    <div id="map_canvas" class="mapping"></div>
    <a href="" id="maps">submit</a>
</div>
<script>

function initialize() {
    var map;
    var bounds = new google.maps.LatLngBounds();
    var mapOptions = {
        zoom:10,
        mapTypeId: 'roadmap'
    };
    var directionsService = new google.maps.DirectionsService;
    map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
    var directionsDisplay = new google.maps.DirectionsRenderer({map:map});
    map.setTilt(45);
    var dataString = "{{locations}}";
    var dataArray = [];
    dataArray = dataString.split(',');
    var markers = [];
    for(var j=0;j<dataArray.length;j+=2)    
    {
        markers.push(
            [
                "dustbin "+j, 
                dataArray[j], 
                dataArray[j+1]
            ]
        );
    }
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(position){
            var pos = {
                lat:position.coords.latitude,
                lng:position.coords.longitude
            };
            displayMarkers(markers,map,bounds,pos,directionsService,directionsDisplay);    
        },
        function(){
            handleLocationError(true,map.getCentre());
        });
    }
    else{
        handleLocationError(false,map.getCentre());
    }
}

//display markers
function displayMarkers(markers,myMap,bounds,myPos,directionsService,directionsDisplay){
    var image= new google.maps.MarkerImage("dustbin.png", null, null, null, new google.maps.Size(20,22));      
    var image2 = new google.maps.MarkerImage("self.png",null,null,null, new google.maps.Size(30,30));
    var markArr=[];
     for( i = 0; i < markers.length; i++ ) {
         var position = new google.maps.LatLng(markers[i][1], markers[i][2]);
         bounds.extend(position);
         marker = new google.maps.Marker({
             position: position,
             map: myMap,
             icon : image,
             title: markers[i][0]
        });

        marker.addListener('click',function(evt){
            var markerLatLng = {lat:evt.latLng.lat(),lng:evt.latLng.lng()};
            calculateDirectionsDisplay(myMap,myPos,markerLatLng,directionsService,directionsDisplay);
            
        });
        markArr.push(marker);
         // Display multiple markers on a map
         var infoWindow = new google.maps.InfoWindow(), marker, i;
         // Loop through our array of markers & place each one on the map   
         myMap.fitBounds(bounds);
         // Automatically center the map fitting all markers on the screen
          // Override our map zoom level once our fitBounds function runs (Make sure it only runs once)
        
    }
    var markerCluster = new MarkerClusterer(myMap, markArr,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
      
    marker=new google.maps.Marker({
        map:myMap,
        position:myPos,
        icon: image2
    });
    myMap.setCenter(new google.maps.LatLng(myPos));
    console.log(marker);
    var boundsListener = google.maps.event.addListener((myMap), 'bounds_changed', function(event) {
        myMap.setZoom(10);
        google.maps.event.removeListener(boundsListener);
        });
    
   
}

//calculate directions and display
function calculateDirectionsDisplay(myMap,myPos,markerLatLng,directionsService,directionsDisplay){
    console.log(myPos,markerLatLng);
    
    directionsService.route({
        origin: myPos,
        destination: markerLatLng,
        travelMode: 'DRIVING'
    }, function(response,status){
        if (status === 'OK') {
        console.log("directionapires",response);
        directionsDisplay.setDirections(response);
    } 
        else {
        window.alert('Directions request failed due to ' + status);
    }
    });
    myMap.setCenter(markerLatLng);
    myMap.setZoom(55);
    console.log(directionsService);
    document.getElementById("maps").href="https://www.google.co.in/maps/dir/" +String(myPos.lat)+","+String(myPos.lng)+"/"+String(markerLatLng.lat)+","+String(markerLatLng.lng)+"/";
}

</script>