
<script>

    function refreshMaps(){
        const object = new Object();
        object.dustBinId  = document.getElementById('id').value;
        object.mylat = document.getElementById('mylat').value;
        object.mylong = document.getElementById('mylng').value;
        object.lat = document.getElementById('mlat').value;
        object.long = document.getElementById('mlng').value;
        console.log("Sent value",object);
        socket.emit("dustBinId",object);
        window.location.href = "https://www.google.co.in/maps/dir/" +String(object.mylat)+","+String(object.mylong)+"/"+String(object.lat)+","+String(object.long)+"/";
    }
    socket.on('refresh',function(data){
        console.log("received reply");
        console.log("data",data);
        initialize(data);
    });
function initialize(data) {
    var map;
    var bounds = new google.maps.LatLngBounds();
    var mapOptions = {
        zoom:10,
        mapTypeId: 'roadmap'
    };
    var directionsService = new google.maps.DirectionsService;
    map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
    var directionsDisplay = new google.maps.DirectionsRenderer({map:map});
    map.setTilt(45);
    loadData(data);
}

function loadData(data) {
    var dataArray = [];
    dataArray = data;
    console.log(data);
    console.log("gf",dataArray.length)
    var markers = [];
    for(var j=0;j<dataArray.length;j+=4)    
    {
        markers.push(
            [
                "dustbin "+j, 
                dataArray[j], 
                dataArray[j+1],
                dataArray[j+2],
                dataArray[j+3]
            ]
        );
    }

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(position){
            var pos = {
                lat:position.coords.latitude,
                lng:position.coords.longitude
            };
            displayMarkers(markers,map,bounds,pos,directionsService,directionsDisplay);    
        },
        function(){
            handleLocationError(true,map.getCentre());
        });
    }
    else{
        handleLocationError(false,map.getCentre());
    }
}

//display markers
function displayMarkers(markers,myMap,bounds,myPos,directionsService,directionsDisplay){
    var image= new google.maps.MarkerImage("/images/dustbin.png", null, null, null, new google.maps.Size(20,22));      
    var image2 = new google.maps.MarkerImage("/images/self.png",null,null,null, new google.maps.Size(30,30));
    var markArr=[];
            console.log(markers);

     for( i = 0; i < markers.length; i++ ) {
        if(markers[i][4]=="full"){   
        
            var position = new google.maps.LatLng(markers[i][2], markers[i][3]);
            bounds.extend(position);
            marker = new google.maps.Marker({
                position: position,
                map: myMap,
                icon : image,
                title: markers[i][0],
            });
            marker.set("id", markers[i][1]);
            var myId = marker.get("id");
            console.log(myId);
        }
        else
            continue;

        marker.addListener('click',function(evt){
            var markerLatLng = {lat:evt.latLng.lat(),lng:evt.latLng.lng()};
            document.getElementById("id").value=this.id;
            document.getElementById("mylat").value=myPos.lat;
            document.getElementById("mylng").value=myPos.lng;
            document.getElementById("mlat").value=markerLatLng.lat;
            document.getElementById("mlng").value=markerLatLng.lng;
            calculateDirectionsDisplay(myMap,myPos,markerLatLng,directionsService,directionsDisplay);
            
        });
        
        markArr.push(marker);
         // Display multiple markers on a map
         var infoWindow = new google.maps.InfoWindow(), marker, i;
         // Loop through our array of markers & place each one on the map   
         myMap.fitBounds(bounds);
         // Automatically center the map fitting all markers on the screen
          // Override our map zoom level once our fitBounds function runs (Make sure it only runs once)

        
    }
    var markerCluster = new MarkerClusterer(myMap, markArr,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
      
    marker=new google.maps.Marker({
        map:myMap,
        position:myPos,
        icon: image2
    });
    myMap.setCenter(new google.maps.LatLng(myPos));
    console.log(marker);
    var boundsListener = google.maps.event.addListener((myMap), 'bounds_changed', function(event) {
        myMap.setZoom(10);
        google.maps.event.removeListener(boundsListener);
        });
    
   
}

//calculate directions and display
function calculateDirectionsDisplay(myMap,myPos,markerLatLng,directionsService,directionsDisplay){
    console.log(myPos,markerLatLng);
    
    directionsService.route({
        origin: myPos,
        destination: markerLatLng,
        travelMode: 'DRIVING'
    }, function(response,status){
        if (status === 'OK') {
        console.log("directionapires",response);
        directionsDisplay.setDirections(response);
    } 
        else {
        window.alert('Directions request failed due to ' + status);
    }
    });
    myMap.setCenter(markerLatLng);
    myMap.setZoom(55);
    console.log(directionsService);
   
    

}

</script>
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9q7X02IpHJI_GYGjfIvvp8y9Ffp--EX0&callback=initialize">
</script>